<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Class: Comment</title>
<link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '';
  if (relpath != '') relpath += '/';
</script>
<script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="js/app.js"></script>

  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (C)</a> &raquo; 
    
    
    <span class="title">Comment</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  <a id="class_list_link" href="#">Class List</a>
  <a id="method_list_link" href="#">Method List</a>
  <a id ="file_list_link" href="#">File List</a>
</div>

      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: Comment
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Comment</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2">MongoMapper::Document</dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">app/models/comment.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>
A Comment on a Discussion by a User
</p>


  </div>
</div>
<div class="tags">
  
</div>
  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="TAG-constant" class="">TAG =
          <div class="docstring">
  <div class="discussion">
    <p>
The Regexp used to parse Tags from Comments
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[^\w]#([-\w\d]{3,40})</span><span class='regexp_end'>/im</span></span></pre></dd>
      
        <dt id="MENTION-constant" class="">MENTION =
          <div class="docstring">
  <div class="discussion">
    <p>
The Regexp used to parse mentions from Comments
</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>([A|C|D|S]MZ\w{7})</span><span class='regexp_end'>/m</span></span></pre></dd>
      
    </dl>
  


  

  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#count_mentions-class_method" title="count_mentions (class method)">+ (Object) <strong>count_mentions</strong>(focus) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Counts the number of Comments that mention a Focus.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#mentioning-class_method" title="mentioning (class method)">+ (Object) <strong>mentioning</strong>(focus, *args) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Finds Comments mentioning a Focus.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#recent-class_method" title="recent (class method)">+ (Object) <strong>recent</strong>(*args) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
The most recent Comments.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#search-class_method" title="search (class method)">+ (Object) <strong>search</strong>(*args) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Until MongoMapper includes full-text search, this is how searching is
implemented.
</p>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#archive_and_destroy_as-instance_method" title="#archive_and_destroy_as (instance method)">- (Object) <strong>archive_and_destroy_as</strong>(destroying_user) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Archive and destroy this Comment.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#cast_vote_by-instance_method" title="#cast_vote_by (instance method)">- (Object) <strong>cast_vote_by</strong>(user) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Atomic operation to let a User vote for a Comment.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create_revision_as-instance_method" title="#create_revision_as (instance method)">- (Object) <strong>create_revision_as</strong>(revising_user) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Create a revision by a User.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#create_tags-instance_method" title="#create_tags (instance method)">- (Object) <strong>create_tags</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Denormalize Tags from this Comment to the Discussion and Focus.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#denormalize_counts-instance_method" title="#denormalize_counts (instance method)">- (Object) <strong>denormalize_counts</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Trigger the Discussion&#8217;s denormalized counter.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#destroy_tags-instance_method" title="#destroy_tags (instance method)">- (Object) <strong>destroy_tags</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Removes tags created by this Comment (on destroy).
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#focus-instance_method" title="#focus (instance method)">- (Object) <strong>focus</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
The focus of this comment.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#nullify_responses-instance_method" title="#nullify_responses (instance method)">- (Object) <strong>nullify_responses</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Clean up responses referring to this Comment (on destroy).
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#parse_body-instance_method" title="#parse_body (instance method)">- (Object) <strong>parse_body</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Finds tags and mentions in the comment body.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#path-instance_method" title="#path (instance method)">- (Object) <strong>path</strong>(*args) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Returns a targeted path to this Comment.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#position-instance_method" title="#position (instance method)">- (Fixnum) <strong>position</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Counts how many Comments came before this one.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#pull_tags-instance_method" title="#pull_tags (instance method)">- (Object) <strong>pull_tags</strong>(old_tags) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Removes tags from the Discussion and Focus.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#push_tags-instance_method" title="#push_tags (instance method)">- (Object) <strong>push_tags</strong>(new_tags) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Adds new Tags to the Discussion and Focus.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#response%3F-instance_method" title="#response? (instance method)">- (Boolean) <strong>response?</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
True if this Comment is a response to another.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#response_to-instance_method" title="#response_to (instance method)">- (Object) <strong>response_to</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
The Comment being responded to.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#response_to%3D-instance_method" title="#response_to= (instance method)">- (Object) <strong>response_to=</strong>(comment) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Sets the Comment being responded to.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_focus-instance_method" title="#set_focus (instance method)">- (Object) <strong>set_focus</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Sets the Focus of this Comment.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#split_body-instance_method" title="#split_body (instance method)">- (Object) <strong>split_body</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Splits the body into an array and appends some metadata for searching.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#synchronize-instance_method" title="#synchronize (instance method)">- (Object) <strong>synchronize</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Synchronizes denormalized values.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#synchronize_tags-instance_method" title="#synchronize_tags (instance method)">- (Object) <strong>synchronize_tags</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Denormalize Tags from this Comment to the Discussion and Focus.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#to_embedded_hash-instance_method" title="#to_embedded_hash (instance method)">- (Object) <strong>to_embedded_hash</strong> </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Serialize to an embedded hash that also contains a serialized revision
history.
</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#update_attributes-instance_method" title="#update_attributes (instance method)">- (Object) <strong>update_attributes</strong>(*args) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>
Updates attributes with Revision history.
</p>
</div></span>
  
</li>

      
    </ul>
  


  

  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="count_mentions-class_method">
  
    + (<tt>Object</tt>) <strong>count_mentions</strong>(focus) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Counts the number of Comments that mention a Focus
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='type'></span>
      
      
        <span class='name'>focus</span>
      
      
      
        &mdash;
        <div class='inline'><p>
The Focus to search for
</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


104
105
106</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 104</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id count_mentions'>count_mentions</span><span class='lparen'>(</span><span class='id focus'>focus</span><span class='rparen'>)</span>
  <span class='const'>Comment</span><span class='period'>.</span><span class='id where'>where</span><span class='lparen'>(</span><span class='symbol'>:mentions</span> <span class='op'>=&gt;</span> <span class='id focus'>focus</span><span class='period'>.</span><span class='id zooniverse_id'>zooniverse_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id count'>count</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="mentioning-class_method">
  
    + (<tt>Object</tt>) <strong>mentioning</strong>(focus, *args) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Finds Comments mentioning a Focus
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='type'></span>
      
      
        <span class='name'>focus</span>
      
      
      
        &mdash;
        <div class='inline'><p>
The Focus to search for
</p>
</div>
      
    </li>
  
    <li>
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <span class='name'>*args</span>
      
      
      
        &mdash;
        <div class='inline'><p>
a customizable set of options
</p>
</div>
      
    </li>
  
</ul>

  
    
    
    
    
    <h3>Options Hash (<tt>*args</tt>):</h3>
    <ul class="option">
      
        <li>
          <span class="type">(<tt>Fixnum</tt>)</span>
          <span class="name">:page</span>
          <span class="default">
            
              &mdash; default:
              <tt>1</tt>
            
          </span>
          &mdash; <div class='inline'><p>
The page of results to find
</p>
</div>
        </tr>
      
        <li>
          <span class="type">(<tt>Fixnum</tt>)</span>
          <span class="name">:per_page</span>
          <span class="default">
            
              &mdash; default:
              <tt>10</tt>
            
          </span>
          &mdash; <div class='inline'><p>
The number of results per page
</p>
</div>
        </tr>
      
        <li>
          <span class="type">(<tt>Symbol</tt>)</span>
          <span class="name">:order</span>
          <span class="default">
            
              &mdash; default:
              <tt>:created_at.desc</tt>
            
          </span>
          &mdash; <div class='inline'><p>
The sort order to use
</p>
</div>
        </tr>
      
    </ul>
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


97
98
99
100</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 97</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id mentioning'>mentioning</span><span class='lparen'>(</span><span class='id focus'>focus</span><span class='comma'>,</span> <span class='op'>*</span><span class='id args'>args</span><span class='rparen'>)</span>
  <span class='id opts'>opts</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:page</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='comma'>,</span> <span class='symbol'>:per_page</span> <span class='op'>=&gt;</span> <span class='int'>10</span><span class='comma'>,</span> <span class='symbol'>:order</span> <span class='op'>=&gt;</span> <span class='symbol'>:created_at</span><span class='period'>.</span><span class='id desc'>desc</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id update'>update</span><span class='lparen'>(</span><span class='id args'>args</span><span class='period'>.</span><span class='id extract_options!'>extract_options!</span><span class='rparen'>)</span>
  <span class='const'>Comment</span><span class='period'>.</span><span class='id sort'>sort</span><span class='lparen'>(</span><span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:order</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id where'>where</span><span class='lparen'>(</span><span class='symbol'>:mentions</span> <span class='op'>=&gt;</span> <span class='id focus'>focus</span><span class='period'>.</span><span class='id zooniverse_id'>zooniverse_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id paginate'>paginate</span> <span class='symbol'>:page</span> <span class='op'>=&gt;</span> <span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:page</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:per_page</span> <span class='op'>=&gt;</span> <span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:per_page</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="recent-class_method">
  
    + (<tt>Object</tt>) <strong>recent</strong>(*args) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
The most recent Comments
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
        <span class='name'>*args</span>
      
      
      
        &mdash;
        <div class='inline'><p>
Pagination options
</p>
</div>
      
    </li>
  
</ul>

  
    
    
    <h3>Options Hash (<tt>*args</tt>):</h3>
    <ul class="option">
      
        <li>
          <span class="type">(<tt>Fixnum</tt>)</span>
          <span class="name">:page</span>
          <span class="default">
            
              &mdash; default:
              <tt>1</tt>
            
          </span>
          &mdash; <div class='inline'><p>
The page of Comments to find
</p>
</div>
        </tr>
      
        <li>
          <span class="type">(<tt>Fixnum</tt>)</span>
          <span class="name">:per_page</span>
          <span class="default">
            
              &mdash; default:
              <tt>10</tt>
            
          </span>
          &mdash; <div class='inline'><p>
The number of Comments per page
</p>
</div>
        </tr>
      
    </ul>
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


87
88
89
90</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 87</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id recent'>recent</span><span class='lparen'>(</span><span class='op'>*</span><span class='id args'>args</span><span class='rparen'>)</span>
  <span class='id opts'>opts</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:page</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='comma'>,</span> <span class='symbol'>:per_page</span> <span class='op'>=&gt;</span> <span class='int'>10</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id update'>update</span><span class='lparen'>(</span><span class='id args'>args</span><span class='period'>.</span><span class='id extract_options!'>extract_options!</span><span class='rparen'>)</span>
  <span class='const'>Comment</span><span class='period'>.</span><span class='id sort'>sort</span><span class='lparen'>(</span><span class='symbol'>:created_at</span><span class='period'>.</span><span class='id desc'>desc</span><span class='rparen'>)</span><span class='period'>.</span><span class='id paginate'>paginate</span> <span class='symbol'>:page</span> <span class='op'>=&gt;</span> <span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:page</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:per_page</span> <span class='op'>=&gt;</span> <span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:per_page</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="search-class_method">
  
    + (<tt>Object</tt>) <strong>search</strong>(*args) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Until MongoMapper includes full-text search, this is how searching is
implemented
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
        <span class='name'>*args</span>
      
      
      
        &mdash;
        <div class='inline'><p>
The search terms
</p>
</div>
      
    </li>
  
</ul>

  
    
    
    <h3>Options Hash (<tt>*args</tt>):</h3>
    <ul class="option">
      
        <li>
          <span class="type">(<tt>Fixnum</tt>)</span>
          <span class="name">:page</span>
          <span class="default">
            
              &mdash; default:
              <tt>1</tt>
            
          </span>
          &mdash; <div class='inline'><p>
The page of results to find
</p>
</div>
        </tr>
      
        <li>
          <span class="type">(<tt>Fixnum</tt>)</span>
          <span class="name">:per_page</span>
          <span class="default">
            
              &mdash; default:
              <tt>10</tt>
            
          </span>
          &mdash; <div class='inline'><p>
The number of results per page
</p>
</div>
        </tr>
      
        <li>
          <span class="type">(<tt>Symbol</tt>)</span>
          <span class="name">:operator</span>
          <span class="default">
            
              &mdash; default:
              <tt>:$all</tt>
            
          </span>
          &mdash; <div class='inline'><p>
The MM operator logic to use
</p>
</div>
        </tr>
      
        <li>
          <span class="type">(<tt>Symbol</tt>)</span>
          <span class="name">:order</span>
          <span class="default">
            
              &mdash; default:
              <tt>:created_at.desc</tt>
            
          </span>
          &mdash; <div class='inline'><p>
The sort order to use
</p>
</div>
        </tr>
      
        <li>
          <span class="type">(<tt>Symbol</tt>)</span>
          <span class="name">:field</span>
          <span class="default">
            
              &mdash; default:
              <tt>:_body</tt>
            
          </span>
          &mdash; <div class='inline'><p>
The Document key to search on
</p>
</div>
        </tr>
      
    </ul>
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


44
45
46
47
48
49
50
51
52
53
54
55</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 44</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id search'>search</span><span class='lparen'>(</span><span class='op'>*</span><span class='id args'>args</span><span class='rparen'>)</span>
  <span class='id opts'>opts</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:page</span> <span class='op'>=&gt;</span> <span class='int'>1</span><span class='comma'>,</span> <span class='symbol'>:operator</span> <span class='op'>=&gt;</span> <span class='symbol'>:$all</span><span class='comma'>,</span> <span class='symbol'>:per_page</span> <span class='op'>=&gt;</span> <span class='int'>10</span><span class='comma'>,</span> <span class='symbol'>:order</span> <span class='op'>=&gt;</span> <span class='symbol'>:created_at</span><span class='period'>.</span><span class='id desc'>desc</span><span class='comma'>,</span> <span class='symbol'>:field</span> <span class='op'>=&gt;</span> <span class='symbol'>:_body</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id update'>update</span><span class='lparen'>(</span><span class='id args'>args</span><span class='period'>.</span><span class='id extract_options!'>extract_options!</span><span class='rparen'>)</span>
  <span class='id args'>args</span> <span class='op'>=</span> <span class='id args'>args</span><span class='period'>.</span><span class='id collect'>collect</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:split</span><span class='rparen'>)</span><span class='period'>.</span><span class='id flatten'>flatten</span>
  <span class='id args'>args</span> <span class='op'>=</span> <span class='id args'>args</span><span class='period'>.</span><span class='id map'>map</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id arg'>arg</span><span class='op'>|</span> <span class='id arg'>arg</span><span class='period'>.</span><span class='id downcase'>downcase</span><span class='period'>.</span><span class='id gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\W</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span> <span class='kw'>if</span> <span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:field</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:_body</span>
  <span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:per_page</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:limit</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id opts'>opts</span><span class='period'>.</span><span class='id has_key?'>has_key?</span><span class='lparen'>(</span><span class='symbol'>:limit</span><span class='rparen'>)</span>
  
  <span class='id criteria'>criteria</span> <span class='op'>=</span> <span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:criteria</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='id criteria'>criteria</span><span class='lbracket'>[</span><span class='symbol'>:focus_type</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:focus_type</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id singularize'>singularize</span><span class='period'>.</span><span class='id camelize'>camelize</span> <span class='kw'>if</span> <span class='id opts'>opts</span><span class='period'>.</span><span class='id has_key?'>has_key?</span><span class='lparen'>(</span><span class='symbol'>:focus_type</span><span class='rparen'>)</span>
  <span class='id criteria'>criteria</span><span class='period'>.</span><span class='id merge!'>merge!</span><span class='lparen'>(</span><span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:field</span><span class='rbracket'>]</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:operator</span><span class='rbracket'>]</span> <span class='op'>=&gt;</span> <span class='id args'>args</span> <span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id args'>args</span><span class='period'>.</span><span class='id nil?'>nil?</span>
  <span class='kw'>return</span> <span class='lbracket'>[</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id criteria'>criteria</span><span class='period'>.</span><span class='id blank?'>blank?</span>
  <span class='id where'>where</span><span class='lparen'>(</span><span class='id criteria'>criteria</span><span class='rparen'>)</span><span class='period'>.</span><span class='id sort'>sort</span><span class='lparen'>(</span><span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:order</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id paginate'>paginate</span><span class='lparen'>(</span><span class='symbol'>:page</span> <span class='op'>=&gt;</span> <span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:page</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:per_page</span> <span class='op'>=&gt;</span> <span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:per_page</span><span class='rbracket'>]</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="archive_and_destroy_as-instance_method">
  
    - (<tt>Object</tt>) <strong>archive_and_destroy_as</strong>(destroying_user) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Archive and destroy this Comment
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='type'>(<tt><span class='object_link'><a href="User.html" title="User (class)">User</a></span></tt>)</span>
      
      
        <span class='name'>destroying_user</span>
      
      
      
        &mdash;
        <div class='inline'><p>
The User destroying this Comment
</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 202</span>

<span class='kw'>def</span> <span class='id archive_and_destroy_as'>archive_and_destroy_as</span><span class='lparen'>(</span><span class='id destroying_user'>destroying_user</span><span class='rparen'>)</span>
  <span class='const'>Archive</span><span class='period'>.</span><span class='id create'>create</span><span class='lparen'>(</span><span class='lbrace'>{</span>
    <span class='symbol'>:kind</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Comment</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
    <span class='symbol'>:original_id</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id id'>id</span><span class='comma'>,</span>
    <span class='symbol'>:user_id</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id author_id'>author_id</span><span class='comma'>,</span>
    <span class='symbol'>:destroying_user_id</span> <span class='op'>=&gt;</span> <span class='id destroying_user'>destroying_user</span><span class='period'>.</span><span class='id id'>id</span><span class='comma'>,</span>
    <span class='symbol'>:original_document</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id to_embedded_hash'>to_embedded_hash</span>
  <span class='rbrace'>}</span><span class='rparen'>)</span>
  
  <span class='kw'>self</span><span class='period'>.</span><span class='id events'>events</span><span class='period'>.</span><span class='id each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id event'>event</span><span class='op'>|</span>
    <span class='id event'>event</span><span class='period'>.</span><span class='id moderator'>moderator</span> <span class='op'>=</span> <span class='id destroying_user'>destroying_user</span>
    <span class='id event'>event</span><span class='period'>.</span><span class='id state'>state</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>actioned</span><span class='tstring_end'>&quot;</span></span>
    <span class='id event'>event</span><span class='period'>.</span><span class='id save'>save</span>
  <span class='kw'>end</span>
  
  <span class='kw'>self</span><span class='period'>.</span><span class='id destroy'>destroy</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="cast_vote_by-instance_method">
  
    - (<tt>Object</tt>) <strong>cast_vote_by</strong>(user) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Atomic operation to let a User vote for a Comment
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='type'>(<tt><span class='object_link'><a href="User.html" title="User (class)">User</a></span></tt>)</span>
      
      
        <span class='name'>user</span>
      
      
      
        &mdash;
        <div class='inline'><p>
The User upvoting this Comment
</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


77
78
79
80
81</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 77</span>

<span class='kw'>def</span> <span class='id cast_vote_by'>cast_vote_by</span><span class='lparen'>(</span><span class='id user'>user</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id author'>author</span><span class='period'>.</span><span class='id id'>id</span> <span class='op'>==</span> <span class='id user'>user</span><span class='period'>.</span><span class='id id'>id</span>
  <span class='const'>Comment</span><span class='period'>.</span><span class='id collection'>collection</span><span class='period'>.</span><span class='id update'>update</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>_id</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id id'>id</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>$addToSet</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>upvotes</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='id user'>user</span><span class='period'>.</span><span class='id id'>id</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id discussion'>discussion</span><span class='period'>.</span><span class='id update_counts'>update_counts</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="create_revision_as-instance_method">
  
    - (<tt>Object</tt>) <strong>create_revision_as</strong>(revising_user) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Create a revision by a User
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='type'>(<tt><span class='object_link'><a href="User.html" title="User (class)">User</a></span></tt>)</span>
      
      
        <span class='name'>revising_user</span>
      
      
      
        &mdash;
        <div class='inline'><p>
The User revising the Comment
</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


180
181
182
183
184
185
186
187
188
189
190
191</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 180</span>

<span class='kw'>def</span> <span class='id create_revision_as'>create_revision_as</span><span class='lparen'>(</span><span class='id revising_user'>revising_user</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id changes'>changes</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>body</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span>
  
  <span class='const'>Revision</span><span class='period'>.</span><span class='id create'>create</span><span class='lparen'>(</span><span class='lbrace'>{</span>
    <span class='symbol'>:original_id</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id id'>id</span><span class='comma'>,</span>
    <span class='symbol'>:author_id</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id author_id'>author_id</span><span class='comma'>,</span>
    <span class='symbol'>:revising_user_id</span> <span class='op'>=&gt;</span> <span class='id revising_user'>revising_user</span><span class='period'>.</span><span class='id id'>id</span><span class='comma'>,</span>
    <span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='id changes'>changes</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>body</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
  <span class='rbrace'>}</span><span class='rparen'>)</span>
  
  <span class='kw'>self</span><span class='period'>.</span><span class='id edit_count'>edit_count</span> <span class='op'>+=</span> <span class='int'>1</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="create_tags-instance_method">
  
    - (<tt>Object</tt>) <strong>create_tags</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Denormalize Tags from this Comment to the Discussion and Focus
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


228
229
230</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 228</span>

<span class='kw'>def</span> <span class='id create_tags'>create_tags</span>
  <span class='id push_tags'>push_tags</span> <span class='kw'>self</span><span class='period'>.</span><span class='id tags'>tags</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="denormalize_counts-instance_method">
  
    - (<tt>Object</tt>) <strong>denormalize_counts</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Trigger the Discussion&#8217;s denormalized counter
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


249
250
251</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 249</span>

<span class='kw'>def</span> <span class='id denormalize_counts'>denormalize_counts</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id discussion'>discussion</span><span class='period'>.</span><span class='id update_counts'>update_counts</span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id discussion'>discussion</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="destroy_tags-instance_method">
  
    - (<tt>Object</tt>) <strong>destroy_tags</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Removes tags created by this Comment (on destroy)
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


244
245
246</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 244</span>

<span class='kw'>def</span> <span class='id destroy_tags'>destroy_tags</span>
  <span class='id pull_tags'>pull_tags</span> <span class='kw'>self</span><span class='period'>.</span><span class='id tags'>tags</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="focus-instance_method">
  
    - (<tt>Object</tt>) <strong>focus</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
The focus of this comment
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


109
110
111
112</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 109</span>

<span class='kw'>def</span> <span class='id focus'>focus</span>
  <span class='kw'>return</span> <span class='kw'>nil</span> <span class='kw'>unless</span> <span class='kw'>self</span><span class='period'>.</span><span class='id focus_type'>focus_type</span> <span class='op'>&amp;&amp;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id focus_id'>focus_id</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id focus_type'>focus_type</span><span class='period'>.</span><span class='id constantize'>constantize</span><span class='period'>.</span><span class='id find'>find</span><span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id focus_id'>focus_id</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="nullify_responses-instance_method">
  
    - (<tt>Object</tt>) <strong>nullify_responses</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Clean up responses referring to this Comment (on destroy)
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


233
234
235
236
237
238
239
240
241</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 233</span>

<span class='kw'>def</span> <span class='id nullify_responses'>nullify_responses</span>
  <span class='const'>Comment</span><span class='period'>.</span><span class='id collection'>collection</span><span class='period'>.</span><span class='id update'>update</span><span class='lparen'>(</span><span class='lbrace'>{</span>
    <span class='symbol'>:response_to_id</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id id'>id</span>
  <span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span>
    <span class='symbol'>:$set</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span>
      <span class='symbol'>:response_to_id</span> <span class='op'>=&gt;</span> <span class='kw'>nil</span>
    <span class='rbrace'>}</span>
  <span class='rbrace'>}</span><span class='comma'>,</span> <span class='symbol'>:multi</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="parse_body-instance_method">
  
    - (<tt>Object</tt>) <strong>parse_body</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Finds tags and mentions in the comment body
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


161
162
163
164
165</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 161</span>

<span class='kw'>def</span> <span class='id parse_body'>parse_body</span>
  <span class='id parsable'>parsable</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span> <span class='kw'>self</span><span class='period'>.</span><span class='id body'>body</span> <span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id tags'>tags</span> <span class='op'>=</span> <span class='id parsable'>parsable</span><span class='period'>.</span><span class='id scan'>scan</span><span class='lparen'>(</span><span class='const'>TAG</span><span class='rparen'>)</span><span class='period'>.</span><span class='id flatten'>flatten</span><span class='period'>.</span><span class='id map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:downcase</span><span class='rparen'>)</span><span class='period'>.</span><span class='id uniq'>uniq</span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id body'>body</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id mentions'>mentions</span> <span class='op'>=</span> <span class='id parsable'>parsable</span><span class='period'>.</span><span class='id scan'>scan</span><span class='lparen'>(</span><span class='const'>MENTION</span><span class='rparen'>)</span><span class='period'>.</span><span class='id flatten'>flatten</span><span class='period'>.</span><span class='id uniq'>uniq</span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id body'>body</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="path-instance_method">
  
    - (<tt>Object</tt>) <strong>path</strong>(*args) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Returns a targeted path to this Comment
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <span class='name'>*args</span>
      
      
      
        &mdash;
        <div class='inline'><p>
a customizable set of options
</p>
</div>
      
    </li>
  
</ul>

  
    
    
    <h3>Options Hash (<tt>*args</tt>):</h3>
    <ul class="option">
      
        <li>
          <span class="type">(<tt>Fixnum</tt>)</span>
          <span class="name">:per_page</span>
          <span class="default">
            
              &mdash; default:
              <tt>10</tt>
            
          </span>
          &mdash; <div class='inline'><p>
The number of Comments per page
</p>
</div>
        </tr>
      
    </ul>
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


123
124
125
126
127
128
129
130
131
132
133</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 123</span>

<span class='kw'>def</span> <span class='id path'>path</span><span class='lparen'>(</span><span class='op'>*</span><span class='id args'>args</span><span class='rparen'>)</span>
  <span class='id opts'>opts</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:per_page</span> <span class='op'>=&gt;</span> <span class='int'>10</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id update'>update</span><span class='lparen'>(</span><span class='id args'>args</span><span class='period'>.</span><span class='id extract_options!'>extract_options!</span><span class='rparen'>)</span>
  <span class='id position'>position</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id position'>position</span>
  <span class='id page'>page</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id position'>position</span> <span class='op'>/</span> <span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:per_page</span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='int'>1</span>
  
  <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id discussion'>discussion</span><span class='period'>.</span><span class='id conversation?'>conversation?</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span> <span class='kw'>self</span><span class='period'>.</span><span class='id discussion'>discussion</span><span class='period'>.</span><span class='id path'>path</span><span class='lparen'>(</span><span class='symbol'>:per_page</span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span><span class='id position'>position</span> <span class='op'>+</span> <span class='int'>1</span><span class='comma'>,</span> <span class='int'>10</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id max'>max</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='tstring_content'>#</span><span class='embexpr_beg'>#{</span> <span class='kw'>self</span><span class='period'>.</span><span class='id _id'>_id</span> <span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span> <span class='kw'>self</span><span class='period'>.</span><span class='id discussion'>discussion</span><span class='period'>.</span><span class='id path'>path</span><span class='lparen'>(</span><span class='symbol'>:per_page</span> <span class='op'>=&gt;</span> <span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:per_page</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:page</span> <span class='op'>=&gt;</span> <span class='id page'>page</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='tstring_content'>#</span><span class='embexpr_beg'>#{</span> <span class='kw'>self</span><span class='period'>.</span><span class='id _id'>_id</span> <span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="position-instance_method">
  
    - (<tt>Fixnum</tt>) <strong>position</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Counts how many Comments came before this one.
</p>


  </div>
</div>
<div class="tags">
  <h3>Returns:</h3>
<ul class="return">
  
    <li>
      
        <span class='type'>(<tt>Fixnum</tt>)</span>
      
      
      
      
        &mdash;
        <div class='inline'><p>
List position
</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


116
117
118
119</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 116</span>

<span class='kw'>def</span> <span class='id position'>position</span>
  <span class='id direction'>direction</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id discussion'>discussion</span><span class='period'>.</span><span class='id conversation?'>conversation?</span> <span class='op'>?</span> <span class='symbol'>:created_at</span><span class='period'>.</span><span class='id gt'>gt</span> <span class='op'>:</span> <span class='symbol'>:created_at</span><span class='period'>.</span><span class='id lt'>lt</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id discussion'>discussion</span><span class='period'>.</span><span class='id comments'>comments</span><span class='period'>.</span><span class='id sort'>sort</span><span class='lparen'>(</span><span class='symbol'>:created_at</span><span class='period'>.</span><span class='id desc'>desc</span><span class='rparen'>)</span><span class='period'>.</span><span class='id count'>count</span><span class='lparen'>(</span><span class='id direction'>direction</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id created_at'>created_at</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="pull_tags-instance_method">
  
    - (<tt>Object</tt>) <strong>pull_tags</strong>(old_tags) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Removes tags from the Discussion and Focus
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 284</span>

<span class='kw'>def</span> <span class='id pull_tags'>pull_tags</span><span class='lparen'>(</span><span class='id old_tags'>old_tags</span><span class='rparen'>)</span>
  <span class='id old_tags'>old_tags</span><span class='period'>.</span><span class='id each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id old_tag'>old_tag</span><span class='op'>|</span>
    <span class='id selector'>selector</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='symbol'>:name</span> <span class='op'>=&gt;</span> <span class='id old_tag'>old_tag</span><span class='comma'>,</span>
      <span class='symbol'>:focus_id</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id focus_id'>focus_id</span>
    <span class='rbrace'>}</span>
    
    <span class='comment'># at least remove the comment from the tagging and decrement the count
</span>    <span class='id updater'>updater</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='symbol'>:$pull</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:comment_ids</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id id'>id</span> <span class='rbrace'>}</span><span class='comma'>,</span>
      <span class='symbol'>:$inc</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:count</span> <span class='op'>=&gt;</span> <span class='op'>-</span><span class='int'>1</span> <span class='rbrace'>}</span>
    <span class='rbrace'>}</span>
    
    <span class='id tagging'>tagging</span> <span class='op'>=</span> <span class='const'>Tagging</span><span class='period'>.</span><span class='id first'>first</span><span class='lparen'>(</span><span class='id selector'>selector</span><span class='rparen'>)</span>
    
    <span class='kw'>if</span> <span class='id tagging'>tagging</span><span class='period'>.</span><span class='id count'>count</span> <span class='op'>==</span> <span class='int'>1</span>
      <span class='comment'># remove the tagging if the count would just go to 0
</span>      <span class='const'>Tagging</span><span class='period'>.</span><span class='id collection'>collection</span><span class='period'>.</span><span class='id remove'>remove</span><span class='lparen'>(</span><span class='id selector'>selector</span><span class='rparen'>)</span>
      
      <span class='kw'>if</span> <span class='qwords_beg'>%w(</span><span class='tstring_content'>Asset</span><span class='words_sep'> </span><span class='tstring_content'>AssetSet</span><span class='words_sep'> </span><span class='tstring_content'>Group</span><span class='words_sep'>)</span><span class='period'>.</span><span class='id include?'>include?</span><span class='lparen'>(</span><span class='id focus_type'>focus_type</span><span class='rparen'>)</span>
        <span class='id klass'>klass</span> <span class='op'>=</span> <span class='id focus_type'>focus_type</span><span class='period'>.</span><span class='id constantize'>constantize</span>
        
        <span class='comment'># remove the tag from the focus if it's not in use anymore
</span>        <span class='id klass'>klass</span><span class='period'>.</span><span class='id collection'>collection</span><span class='period'>.</span><span class='id update'>update</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='symbol'>:_id</span> <span class='op'>=&gt;</span> <span class='id focus_id'>focus_id</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span>
          <span class='symbol'>:$pull</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:tags</span> <span class='op'>=&gt;</span> <span class='id old_tag'>old_tag</span> <span class='rbrace'>}</span>
        <span class='rbrace'>}</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      
    <span class='kw'>else</span>
      <span class='comment'># if only one comment in this discussion has used the tag, then pull the discussion_id from the tagging
</span>      <span class='id ids'>ids</span> <span class='op'>=</span> <span class='const'>Comment</span><span class='period'>.</span><span class='id where'>where</span><span class='lparen'>(</span><span class='symbol'>:discussion_id</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id discussion_id'>discussion_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id only'>only</span><span class='lparen'>(</span><span class='symbol'>:_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id all'>all</span><span class='period'>.</span><span class='id collect'>collect</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:_id</span><span class='rparen'>)</span>
      <span class='id pull_discussion'>pull_discussion</span> <span class='op'>=</span> <span class='id tagging'>tagging</span><span class='period'>.</span><span class='id comment_ids'>comment_ids</span><span class='period'>.</span><span class='id select'>select</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id id'>id</span><span class='op'>|</span> <span class='id ids'>ids</span><span class='period'>.</span><span class='id include?'>include?</span><span class='lparen'>(</span><span class='id id'>id</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id length'>length</span> <span class='op'>&gt;</span> <span class='int'>1</span> <span class='op'>?</span> <span class='kw'>false</span> <span class='op'>:</span> <span class='kw'>true</span>
      
      <span class='id updater'>updater</span><span class='period'>.</span><span class='id merge!'>merge!</span><span class='lparen'>(</span><span class='lbrace'>{</span>
        <span class='symbol'>:$pull</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span>
          <span class='symbol'>:comment_ids</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id id'>id</span><span class='comma'>,</span>
          <span class='symbol'>:discussion_ids</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id discussion_id'>discussion_id</span>
        <span class='rbrace'>}</span>
      <span class='rbrace'>}</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id pull_discussion'>pull_discussion</span>
      
      <span class='const'>Tagging</span><span class='period'>.</span><span class='id collection'>collection</span><span class='period'>.</span><span class='id update'>update</span><span class='lparen'>(</span><span class='id selector'>selector</span><span class='comma'>,</span> <span class='id updater'>updater</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    
    <span class='comment'># Decrement the count for this tag
</span>    <span class='const'>Tag</span><span class='period'>.</span><span class='id collection'>collection</span><span class='period'>.</span><span class='id update'>update</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='symbol'>:name</span> <span class='op'>=&gt;</span> <span class='id old_tag'>old_tag</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span>
      <span class='symbol'>:$inc</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:count</span> <span class='op'>=&gt;</span> <span class='op'>-</span><span class='int'>1</span> <span class='rbrace'>}</span>
    <span class='rbrace'>}</span><span class='rparen'>)</span>
    
    <span class='comment'># Destroy this tag only if the count has gone to 0
</span>    <span class='const'>Tag</span><span class='period'>.</span><span class='id collection'>collection</span><span class='period'>.</span><span class='id remove'>remove</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='symbol'>:name</span> <span class='op'>=&gt;</span> <span class='id old_tag'>old_tag</span><span class='comma'>,</span> <span class='symbol'>:count</span> <span class='op'>=&gt;</span> <span class='int'>0</span> <span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="push_tags-instance_method">
  
    - (<tt>Object</tt>) <strong>push_tags</strong>(new_tags) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Adds new Tags to the Discussion and Focus
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 265</span>

<span class='kw'>def</span> <span class='id push_tags'>push_tags</span><span class='lparen'>(</span><span class='id new_tags'>new_tags</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='qwords_beg'>%w(</span><span class='tstring_content'>Asset</span><span class='words_sep'> </span><span class='tstring_content'>AssetSet</span><span class='words_sep'> </span><span class='tstring_content'>Group</span><span class='words_sep'>)</span><span class='period'>.</span><span class='id include?'>include?</span><span class='lparen'>(</span><span class='id focus_type'>focus_type</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id new_tags'>new_tags</span><span class='period'>.</span><span class='id any?'>any?</span>
    <span class='id klass'>klass</span> <span class='op'>=</span> <span class='id focus_type'>focus_type</span><span class='period'>.</span><span class='id constantize'>constantize</span>
    <span class='id klass'>klass</span><span class='period'>.</span><span class='id collection'>collection</span><span class='period'>.</span><span class='id update'>update</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='symbol'>:_id</span> <span class='op'>=&gt;</span> <span class='id focus_id'>focus_id</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span> <span class='symbol'>:$addToSet</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:tags</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:$each</span> <span class='op'>=&gt;</span> <span class='id new_tags'>new_tags</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  
  <span class='id new_tags'>new_tags</span><span class='period'>.</span><span class='id each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id tag_name'>tag_name</span><span class='op'>|</span>
    <span class='const'>Tag</span><span class='period'>.</span><span class='id collection'>collection</span><span class='period'>.</span><span class='id update'>update</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='symbol'>:name</span> <span class='op'>=&gt;</span> <span class='id tag_name'>tag_name</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span> <span class='symbol'>:$inc</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:count</span> <span class='op'>=&gt;</span> <span class='int'>1</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='symbol'>:upsert</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span>
    
    <span class='kw'>unless</span> <span class='id focus_id'>focus_id</span><span class='period'>.</span><span class='id nil?'>nil?</span>
      <span class='const'>Tagging</span><span class='period'>.</span><span class='id collection'>collection</span><span class='period'>.</span><span class='id update'>update</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='symbol'>:name</span> <span class='op'>=&gt;</span> <span class='id tag_name'>tag_name</span><span class='comma'>,</span> <span class='symbol'>:focus_id</span> <span class='op'>=&gt;</span> <span class='id focus_id'>focus_id</span><span class='comma'>,</span> <span class='symbol'>:focus_type</span> <span class='op'>=&gt;</span> <span class='id focus_type'>focus_type</span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='lbrace'>{</span>
        <span class='symbol'>:$addToSet</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:discussion_ids</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id discussion_id'>discussion_id</span><span class='comma'>,</span> <span class='symbol'>:comment_ids</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id id'>id</span> <span class='rbrace'>}</span><span class='comma'>,</span>
        <span class='symbol'>:$inc</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:count</span> <span class='op'>=&gt;</span> <span class='int'>1</span> <span class='rbrace'>}</span>
      <span class='rbrace'>}</span><span class='comma'>,</span> <span class='symbol'>:upsert</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="response?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>response?</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
True if this Comment is a response to another
</p>


  </div>
</div>
<div class="tags">
  <h3>Returns:</h3>
<ul class="return">
  
    <li>
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


71
72
73</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 71</span>

<span class='kw'>def</span> <span class='id response?'>response?</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id response_to_id'>response_to_id</span><span class='period'>.</span><span class='id nil?'>nil?</span> <span class='op'>?</span> <span class='kw'>false</span> <span class='op'>:</span> <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="response_to-instance_method">
  
    - (<tt>Object</tt>) <strong>response_to</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
The Comment being responded to
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


66
67
68</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 66</span>

<span class='kw'>def</span> <span class='id response_to'>response_to</span>
  <span class='ivar'>@cached_response_to</span> <span class='op'>||=</span> <span class='const'>Comment</span><span class='period'>.</span><span class='id find'>find</span><span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id response_to_id'>response_to_id</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="response_to=-instance_method">
  
    - (<tt>Object</tt>) <strong>response_to=</strong>(comment) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Sets the Comment being responded to
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='type'>(<tt><span class='object_link'><a href="" title="Comment (class)">Comment</a></span></tt>)</span>
      
      
        <span class='name'>Comment</span>
      
      
      
        &mdash;
        <div class='inline'><p>
The Comment being responded to
</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


59
60
61
62
63</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 59</span>

<span class='kw'>def</span> <span class='id response_to='>response_to=</span><span class='lparen'>(</span><span class='id comment'>comment</span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id response_to_id'>response_to_id</span> <span class='op'>=</span> <span class='id comment'>comment</span><span class='period'>.</span><span class='id id'>id</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id save'>save</span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id changed?'>changed?</span>
  <span class='ivar'>@cached_response_to</span> <span class='op'>=</span> <span class='id comment'>comment</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="set_focus-instance_method">
  
    - (<tt>Object</tt>) <strong>set_focus</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Sets the Focus of this Comment
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


221
222
223
224
225</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 221</span>

<span class='kw'>def</span> <span class='id set_focus'>set_focus</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id focus_id'>focus_id</span> <span class='op'>=</span> <span class='id discussion'>discussion</span><span class='period'>.</span><span class='id focus_id'>focus_id</span> <span class='kw'>unless</span> <span class='id discussion'>discussion</span><span class='period'>.</span><span class='id nil?'>nil?</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id focus_type'>focus_type</span> <span class='op'>=</span> <span class='id discussion'>discussion</span><span class='period'>.</span><span class='id focus_type'>focus_type</span> <span class='kw'>unless</span> <span class='id discussion'>discussion</span><span class='period'>.</span><span class='id nil?'>nil?</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id focus_base_type'>focus_base_type</span> <span class='op'>=</span> <span class='id discussion'>discussion</span><span class='period'>.</span><span class='id focus_base_type'>focus_base_type</span> <span class='kw'>unless</span> <span class='id discussion'>discussion</span><span class='period'>.</span><span class='id nil?'>nil?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="split_body-instance_method">
  
    - (<tt>Object</tt>) <strong>split_body</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Splits the body into an array and appends some metadata for searching
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


144
145
146
147
148
149
150
151
152
153
154
155
156
157
158</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 144</span>

<span class='kw'>def</span> <span class='id split_body'>split_body</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id _body'>_body</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id body'>body</span><span class='period'>.</span><span class='id gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\W</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'> </span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id split'>split</span>
  
  <span class='kw'>if</span> <span class='id focus'>focus</span> <span class='op'>&amp;&amp;</span> <span class='id focus_type'>focus_type</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Board</span><span class='tstring_end'>&quot;</span></span>
    <span class='lbracket'>[</span><span class='symbol'>:name</span><span class='comma'>,</span> <span class='symbol'>:description</span><span class='comma'>,</span> <span class='symbol'>:zooniverse_id</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id attr'>attr</span><span class='op'>|</span>
      <span class='id value'>value</span> <span class='op'>=</span> <span class='id focus'>focus</span><span class='period'>.</span><span class='id send'>send</span><span class='lparen'>(</span><span class='id attr'>attr</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id focus'>focus</span><span class='period'>.</span><span class='id respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='id attr'>attr</span><span class='rparen'>)</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id _body'>_body</span> <span class='op'>&lt;&lt;</span> <span class='id value'>value</span><span class='period'>.</span><span class='id gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\W</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'> </span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id split'>split</span> <span class='kw'>unless</span> <span class='id value'>value</span><span class='period'>.</span><span class='id nil?'>nil?</span>
    <span class='kw'>end</span>
    
    <span class='kw'>self</span><span class='period'>.</span><span class='id _body'>_body</span> <span class='op'>&lt;&lt;</span> <span class='id discussion'>discussion</span><span class='period'>.</span><span class='id subject'>subject</span><span class='period'>.</span><span class='id gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\W</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'> </span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id split'>split</span> <span class='kw'>unless</span> <span class='id discussion'>discussion</span><span class='period'>.</span><span class='id nil?'>nil?</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id _body'>_body</span> <span class='op'>&lt;&lt;</span> <span class='id discussion'>discussion</span><span class='period'>.</span><span class='id zooniverse_id'>zooniverse_id</span> <span class='kw'>unless</span> <span class='id discussion'>discussion</span><span class='period'>.</span><span class='id zooniverse_id'>zooniverse_id</span><span class='period'>.</span><span class='id nil?'>nil?</span>
  <span class='kw'>end</span>
  
  <span class='kw'>self</span><span class='period'>.</span><span class='id _body'>_body</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id _body'>_body</span><span class='period'>.</span><span class='id flatten'>flatten</span><span class='period'>.</span><span class='id map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:downcase</span><span class='rparen'>)</span><span class='period'>.</span><span class='id uniq'>uniq</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="synchronize-instance_method">
  
    - (<tt>Object</tt>) <strong>synchronize</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Synchronizes denormalized values
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


136
137
138
139
140
141</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 136</span>

<span class='kw'>def</span> <span class='id synchronize'>synchronize</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id new_record?'>new_record?</span> <span class='comment'># Apparently in Rails 3.0.7 after_validation_on_update callbacks are triggered on new records
</span>  <span class='id split_body'>split_body</span>
  <span class='id parse_body'>parse_body</span>
  <span class='id synchronize_tags'>synchronize_tags</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="synchronize_tags-instance_method">
  
    - (<tt>Object</tt>) <strong>synchronize_tags</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Denormalize Tags from this Comment to the Discussion and Focus
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


254
255
256
257
258
259
260
261
262</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 254</span>

<span class='kw'>def</span> <span class='id synchronize_tags'>synchronize_tags</span>
  <span class='kw'>if</span> <span class='id changes'>changes</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tags</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
    <span class='id added'>added</span> <span class='op'>=</span> <span class='id changes'>changes</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tags</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>-</span> <span class='id changes'>changes</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tags</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
    <span class='id removed'>removed</span> <span class='op'>=</span> <span class='id changes'>changes</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tags</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span> <span class='op'>-</span> <span class='id changes'>changes</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tags</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span>
    
    <span class='id push_tags'>push_tags</span> <span class='id added'>added</span> <span class='kw'>if</span> <span class='id added'>added</span><span class='period'>.</span><span class='id any?'>any?</span>
    <span class='id pull_tags'>pull_tags</span> <span class='id removed'>removed</span> <span class='kw'>if</span> <span class='id removed'>removed</span><span class='period'>.</span><span class='id any?'>any?</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="to_embedded_hash-instance_method">
  
    - (<tt>Object</tt>) <strong>to_embedded_hash</strong> 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Serialize to an embedded hash that also contains a serialized revision
history
</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


194
195
196
197
198</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 194</span>

<span class='kw'>def</span> <span class='id to_embedded_hash'>to_embedded_hash</span>
  <span class='id hash'>hash</span> <span class='op'>=</span> <span class='kw'>self</span><span class='period'>.</span><span class='id to_mongo'>to_mongo</span>
  <span class='id hash'>hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>revisions</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Revision</span><span class='period'>.</span><span class='id all'>all</span><span class='lparen'>(</span><span class='symbol'>:original_id</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id id'>id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id collect'>collect</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:to_mongo</span><span class='rparen'>)</span>
  <span class='id hash'>hash</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="update_attributes-instance_method">
  
    - (<tt>Object</tt>) <strong>update_attributes</strong>(*args) 
  

  
</p><div class="docstring">
  <div class="discussion">
    <p>
Updates attributes with Revision history
</p>


  </div>
</div>
<div class="tags">
  <h3>Parameters:</h3>
<ul class="param">
  
    <li>
      
        <span class='type'>(<tt>Array</tt>)</span>
      
      
        <span class='name'>*args</span>
      
      
      
        &mdash;
        <div class='inline'><p>
The change Hash
</p>
</div>
      
    </li>
  
</ul>

  
    
    
    <h3>Options Hash (<tt>*args</tt>):</h3>
    <ul class="option">
      
        <li>
          <span class="type">(<tt><span class='object_link'><a href="User.html" title="User (class)">User</a></span></tt>)</span>
          <span class="name">:revising_user</span>
          <span class="default">
            
              &mdash; default:
              <tt>author</tt>
            
          </span>
          &mdash; <div class='inline'><p>
The User invoking the change.  Could also being a moderator or admin
</p>
</div>
        </tr>
      
    </ul>
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


170
171
172
173
174
175
176</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/comment.rb', line 170</span>

<span class='kw'>def</span> <span class='id update_attributes'>update_attributes</span><span class='lparen'>(</span><span class='op'>*</span><span class='id args'>args</span><span class='rparen'>)</span>
  <span class='id opts'>opts</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:revising_user</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='period'>.</span><span class='id author'>author</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id update'>update</span><span class='lparen'>(</span><span class='id args'>args</span><span class='period'>.</span><span class='id extract_options!'>extract_options!</span><span class='rparen'>)</span>
  
  <span class='kw'>self</span><span class='period'>.</span><span class='id attributes'>attributes</span> <span class='op'>=</span> <span class='id args'>args</span><span class='period'>.</span><span class='id first'>first</span>
  <span class='id create_revision_as'>create_revision_as</span> <span class='id opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:revising_user</span><span class='rbracket'>]</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id save'>save</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Sun May  1 16:07:45 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.6.7 (ruby-1.9.2).
</div>

  </body>
</html>