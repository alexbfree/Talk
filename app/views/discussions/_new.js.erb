<script type="text/javascript" charset="utf-8">
  var focus_annotation = null;
  
  $(document).ready(function() {
    $("#discussion_comments_body").markItUp(mySettings);
    
    if($('#comment-annotation').length == 0) {
      $('.annotate-button').hide();
    }
  });
  
  function new_annotation() {
    var dialog = $('#comment-annotation');
    if(dialog.length == 1) {
      if(dialog.hasClass('initialized')) {
        reload_notes();
        dialog.dialog('open');
      } else {
        dialog.dialog({
          title: "Add an annotation",
          width: <%= @focus.is_a?(Asset) ? @focus.size[0] : 0 %> + 35,
          height: <%= @focus.is_a?(Asset) ? @focus.size[1] : 0 %> + 105,
          show: 'fade',
          hide: 'fade',
          modal: true,
          draggable: false,
          resizable: false
        });
        
        focus_annotation = $('#comment-focus').annotateImage({
          editable: true,
          useAjax: false,
          markupField: '#discussion_comments_body',
        });
        
        reload_notes();
        
        dialog.bind('dialogclose', function() {
          $('.image-annotate-edit-close').click();
        });
        
        $('.image-annotate-view').show();
        
        dialog.addClass('initialized');
      }
      
      $('.image-annotate-view').show();
    }
  }
  
  function reload_notes() {
    focus_annotation.addAnnotations('#discussion_comments_body');
  }
</script>
