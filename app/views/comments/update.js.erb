if(<%= !@comment.nil? %>) {
  if(<%= @short_display %>) {
    $('#<%= @comment.id %>').html("<%= escape_javascript(render(:partial => "short_comment", :locals => { :short_comment => @comment })) if @short_display %>");
    $('#tags-for-focus').html("<%= escape_javascript(render(:partial => "shared/tags_for_focus")) if @short_display %>");
    $('#<%= @comment.id %> .body').keywordHighlight();
  }
  else {
    var existing_dialog = $('.ui-dialog #<%= @comment.id %>-annotations');
    if(existing_dialog.length > 0) {
      existing_dialog.parent().remove();
      $('#<%= @comment.id %>-annotations').remove();
    }
    
    $('#edit-in-progress').remove();
    $('#edit_comment_<%= @comment.id %>').parent().replaceWith("<%= escape_javascript(render(:partial => "comment", :locals => { :comment => @comment })) unless @short_display %>");
    $('.subtext').html("<%= escape_javascript(render(:partial => "discussions/keywords", :locals => { :discussion => @comment.discussion })) unless @short_display %>");
    $('.new_comment .comment-preview').addClass('in-use');
    $('#<%= @comment.id %> .body').keywordHighlight();
    $('#<%= @comment.id %>.highlight_annotations').highlightAnnotations();
  }
  
  $('.wrapper').prepend("<%= escape_javascript(render(:partial => "shared/flash", :locals => { :flash => flash })) %>");
  <%- flash.clear %>
  OCT.notice.init();
  OCT.hover.init();
}
